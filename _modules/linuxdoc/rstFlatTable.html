
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>linuxdoc.rstFlatTable &#8212; LinuxDoc 20211220 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/tabs.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">LinuxDoc 20211220 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">linuxdoc.rstFlatTable</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for linuxdoc.rstFlatTable</h1><div class="highlight"><pre>
<span></span># -*- coding: utf-8; mode: python -*-
# SPDX-License-Identifier: GPL-2.0
#
# pylint: disable=missing-docstring, arguments-differ, invalid-name
# pylint: disable=too-many-arguments, too-many-locals, too-many-branches
# pylint: disable=too-many-nested-blocks, useless-object-inheritance

&quot;&quot;&quot;\
flat-table
~~~~~~~~~~

Implementation of the ``flat-table`` reST-directive.  User documentation see
:ref:`rest-flat-table`

&quot;&quot;&quot;

# ==============================================================================
# imports
# ==============================================================================

from docutils import nodes
from docutils.parsers.rst import directives, roles
from docutils.parsers.rst.directives.tables import Table
from docutils.utils import SystemMessagePropagation

# ==============================================================================
# common globals
# ==============================================================================

__version__  = &#39;3.0&#39;

# ==============================================================================
<div class="viewcode-block" id="setup"><a class="viewcode-back" href="../../linuxdoc-api/linuxdoc.rstFlatTable.html#linuxdoc.rstFlatTable.setup">[docs]</a>def setup(app):
# ==============================================================================

    app.add_directive(&quot;flat-table&quot;, FlatTable)
    roles.register_local_role(&#39;cspan&#39;, c_span)
    roles.register_local_role(&#39;rspan&#39;, r_span)

    return dict(
        version = __version__,
        parallel_read_safe = True,
        parallel_write_safe = True
    )</div>

# ==============================================================================
<div class="viewcode-block" id="c_span"><a class="viewcode-back" href="../../linuxdoc-api/linuxdoc.rstFlatTable.html#linuxdoc.rstFlatTable.c_span">[docs]</a>def c_span(  # pylint: disable=unused-argument
        name, rawtext, text, lineno, inliner, options=None, content=None):
# ==============================================================================

    options  = options if options is not None else {}
    content  = content if content is not None else []
    nodelist = [colSpan(span=int(text))]
    msglist  = []
    return nodelist, msglist</div>

# ==============================================================================
<div class="viewcode-block" id="r_span"><a class="viewcode-back" href="../../linuxdoc-api/linuxdoc.rstFlatTable.html#linuxdoc.rstFlatTable.r_span">[docs]</a>def r_span(  # pylint: disable=unused-argument
        name, rawtext, text, lineno, inliner, options=None, content=None):
# ==============================================================================

    options  = options if options is not None else {}
    content  = content if content is not None else []
    nodelist = [rowSpan(span=int(text))]
    msglist  = []
    return nodelist, msglist</div>

# ==============================================================================
<div class="viewcode-block" id="rowSpan"><a class="viewcode-back" href="../../linuxdoc-api/linuxdoc.rstFlatTable.html#linuxdoc.rstFlatTable.rowSpan">[docs]</a>class rowSpan(nodes.General, nodes.Element):
# ==============================================================================
    pass</div>

# ==============================================================================
<div class="viewcode-block" id="colSpan"><a class="viewcode-back" href="../../linuxdoc-api/linuxdoc.rstFlatTable.html#linuxdoc.rstFlatTable.colSpan">[docs]</a>class colSpan(nodes.General, nodes.Element):
# ==============================================================================
    pass</div>

# ==============================================================================
<div class="viewcode-block" id="FlatTable"><a class="viewcode-back" href="../../linuxdoc-api/linuxdoc.rstFlatTable.html#linuxdoc.rstFlatTable.FlatTable">[docs]</a>class FlatTable(Table):
# ==============================================================================

    u&quot;&quot;&quot;FlatTable (``flat-table``) directive&quot;&quot;&quot;

    option_spec = {

        &#39;name&#39;: directives.unchanged
        , &#39;class&#39;: directives.class_option
        , &#39;header-rows&#39;: directives.nonnegative_int
        , &#39;stub-columns&#39;: directives.nonnegative_int
        , &#39;widths&#39;: directives.positive_int_list
        , &#39;fill-cells&#39; : directives.flag }

<div class="viewcode-block" id="FlatTable.run"><a class="viewcode-back" href="../../linuxdoc-api/linuxdoc.rstFlatTable.html#linuxdoc.rstFlatTable.FlatTable.run">[docs]</a>    def run(self):

        if not self.content:
            error = self.state_machine.reporter.error(
                &#39;The &quot;%s&quot; directive is empty; content required.&#39; % self.name,
                nodes.literal_block(self.block_text, self.block_text),
                line=self.lineno)
            return [error]

        title, messages = self.make_title()
        node = nodes.Element()          # anonymous container for parsing
        self.state.nested_parse(self.content, self.content_offset, node)

        tableBuilder = ListTableBuilder(self)
        tableBuilder.parseFlatTableNode(node)
        tableNode = tableBuilder.buildTableNode()
        self.add_name(tableNode)
        tableNode[&#39;classes&#39;] += self.options.get(&#39;class&#39;, [])

        # debug --&gt; tableNode.asdom().toprettyxml()
        if title:
            tableNode.insert(0, title)
        return [tableNode] + messages</div></div>


# ==============================================================================
<div class="viewcode-block" id="ListTableBuilder"><a class="viewcode-back" href="../../linuxdoc-api/linuxdoc.rstFlatTable.html#linuxdoc.rstFlatTable.ListTableBuilder">[docs]</a>class ListTableBuilder(object):
# ==============================================================================

    u&quot;&quot;&quot;Builds a table from a double-stage list&quot;&quot;&quot;

    def __init__(self, directive):
        self.directive = directive
        self.rows      = []
        self.max_cols  = 0

<div class="viewcode-block" id="ListTableBuilder.buildTableNode"><a class="viewcode-back" href="../../linuxdoc-api/linuxdoc.rstFlatTable.html#linuxdoc.rstFlatTable.ListTableBuilder.buildTableNode">[docs]</a>    def buildTableNode(self):

        colwidths    = self.directive.get_column_widths(self.max_cols)
        if isinstance(colwidths, tuple):
            # Since docutils 0.13, get_column_widths returns a (widths,
            # colwidths) tuple, where widths is a string (i.e. &#39;auto&#39;).
            # See https://sourceforge.net/p/docutils/patches/120/.
            colwidths = colwidths[1]
        stub_columns = self.directive.options.get(&#39;stub-columns&#39;, 0)
        header_rows  = self.directive.options.get(&#39;header-rows&#39;, 0)

        table = nodes.table()
        tgroup = nodes.tgroup(cols=len(colwidths))
        table += tgroup


        for colwidth in colwidths:
            colspec = nodes.colspec(colwidth=colwidth)
            # FIXME: It seems, that the stub method only works well in the
            # absence of rowspan (observed by the html buidler, the docutils-xml
            # build seems OK).  This is not extraordinary, because there exists
            # no table directive (except *this* flat-table) which allows to
            # define coexistent of rowspan and stubs (there was no use-case
            # before flat-table). This should be reviewed (later).
            if stub_columns:
                colspec.attributes[&#39;stub&#39;] = 1
                stub_columns -= 1
            tgroup += colspec

        if header_rows:
            thead = nodes.thead()
            tgroup += thead
            for row in self.rows[:header_rows]:
                thead += self.buildTableRowNode(row)

        tbody = nodes.tbody()
        tgroup += tbody

        for row in self.rows[header_rows:]:
            tbody += self.buildTableRowNode(row)
        return table</div>

<div class="viewcode-block" id="ListTableBuilder.buildTableRowNode"><a class="viewcode-back" href="../../linuxdoc-api/linuxdoc.rstFlatTable.html#linuxdoc.rstFlatTable.ListTableBuilder.buildTableRowNode">[docs]</a>    def buildTableRowNode(self, row_data, classes=None):  # pylint: disable=no-self-use
        classes = [] if classes is None else classes
        row = nodes.row()
        for cell in row_data:
            if cell is None:
                continue
            cspan, rspan, cellElements = cell

            attributes = {&quot;classes&quot; : classes}
            if rspan:
                attributes[&#39;morerows&#39;] = rspan
            if cspan:
                attributes[&#39;morecols&#39;] = cspan
            entry = nodes.entry(**attributes)
            entry.extend(cellElements)
            row += entry
        return row</div>

<div class="viewcode-block" id="ListTableBuilder.raiseError"><a class="viewcode-back" href="../../linuxdoc-api/linuxdoc.rstFlatTable.html#linuxdoc.rstFlatTable.ListTableBuilder.raiseError">[docs]</a>    def raiseError(self, msg):
        error =  self.directive.state_machine.reporter.error(
            msg
            , nodes.literal_block(self.directive.block_text
                                  , self.directive.block_text)
            , line = self.directive.lineno )
        raise SystemMessagePropagation(error)</div>

<div class="viewcode-block" id="ListTableBuilder.parseFlatTableNode"><a class="viewcode-back" href="../../linuxdoc-api/linuxdoc.rstFlatTable.html#linuxdoc.rstFlatTable.ListTableBuilder.parseFlatTableNode">[docs]</a>    def parseFlatTableNode(self, node):
        u&quot;&quot;&quot;parses the node from a :py:class:`FlatTable` directive&#39;s body&quot;&quot;&quot;

        if len(node) != 1 or not isinstance(node[0], nodes.bullet_list):
            self.raiseError(
                &#39;Error parsing content block for the &quot;%s&quot; directive: &#39;
                &#39;exactly one bullet list expected.&#39; % self.directive.name )

        for rowNum, rowItem in enumerate(node[0]):
            row = self.parseRowItem(rowItem, rowNum)
            self.rows.append(row)
        self.roundOffTableDefinition()</div>

<div class="viewcode-block" id="ListTableBuilder.roundOffTableDefinition"><a class="viewcode-back" href="../../linuxdoc-api/linuxdoc.rstFlatTable.html#linuxdoc.rstFlatTable.ListTableBuilder.roundOffTableDefinition">[docs]</a>    def roundOffTableDefinition(self):
        u&quot;&quot;&quot;Round off the table definition.

        This method rounds off the table definition in :py:attr:`rows`.

        * This method inserts the needed ``None`` values for the missing cells
          arising from spanning cells over rows and/or columns.

        * recount the :py:attr:`max_cols`

        * Autospan or fill (option ``fill-cells``) missing cells on the right
          side of the table-row
        &quot;&quot;&quot;

        y = 0
        while y &lt; len(self.rows):
            x = 0

            while x &lt; len(self.rows[y]):
                cell = self.rows[y][x]
                if cell is None:
                    x += 1
                    continue
                cspan, rspan = cell[:2]
                # handle colspan in current row
                for c in range(cspan):
                    try:
                        self.rows[y].insert(x+c+1, None)
                    except Exception:  # pylint: disable=broad-except
                        # the user sets ambiguous rowspans
                        pass
                # handle colspan in spanned rows
                for r in range(rspan):
                    for c in range(cspan + 1):
                        try:
                            self.rows[y+r+1].insert(x+c, None)
                        except Exception:  # pylint: disable=broad-except
                            # the user sets ambiguous rowspans
                            pass
                x += 1
            y += 1

        # Insert the missing cells on the right side. For this, first
        # re-calculate the max columns.

        for row in self.rows:
            if self.max_cols &lt; len(row):
                self.max_cols = len(row)

        # fill with empty cells or cellspan?

        fill_cells = False
        if &#39;fill-cells&#39; in self.directive.options:
            fill_cells = True

        for row in self.rows:
            x =  self.max_cols - len(row)
            if x and not fill_cells:
                if row[-1] is None:
                    row.append( ( x - 1, 0, []) )
                else:
                    cspan, rspan, content = row[-1]
                    row[-1] = (cspan + x, rspan, content)
            elif x and fill_cells:
                for _i in range(x):
                    row.append( (0, 0, nodes.comment()) )</div>

<div class="viewcode-block" id="ListTableBuilder.pprint"><a class="viewcode-back" href="../../linuxdoc-api/linuxdoc.rstFlatTable.html#linuxdoc.rstFlatTable.ListTableBuilder.pprint">[docs]</a>    def pprint(self):
        # for debugging
        retVal = &quot;[   &quot;
        for row in self.rows:
            retVal += &quot;[ &quot;
            for col in row:
                if col is None:
                    retVal += (&#39;%r&#39; % col)
                    retVal += &quot;\n    , &quot;
                else:
                    content = col[2][0].astext()
                    if len (content) &gt; 30:
                        content = content[:30] + &quot;...&quot;
                    retVal += (&#39;(cspan=%s, rspan=%s, %r)&#39;
                               % (col[0], col[1], content))
                    retVal += &quot;]\n    , &quot;
            retVal = retVal[:-2]
            retVal += &quot;]\n  , &quot;
        retVal = retVal[:-2]
        return retVal + &quot;]&quot;</div>

<div class="viewcode-block" id="ListTableBuilder.parseRowItem"><a class="viewcode-back" href="../../linuxdoc-api/linuxdoc.rstFlatTable.html#linuxdoc.rstFlatTable.ListTableBuilder.parseRowItem">[docs]</a>    def parseRowItem(self, rowItem, rowNum):
        row = []
        childNo = 0
        error   = False
        cell    = None
        target  = None

        for child in rowItem:
            if isinstance(child, (nodes.comment, nodes.system_message)):
                pass
            elif isinstance(child , nodes.target):
                target = child
            elif isinstance(child, nodes.bullet_list):
                childNo += 1
                cell = child
            else:
                error = True
                break

        if childNo != 1 or error:
            self.raiseError(
                &#39;Error parsing content block for the &quot;%s&quot; directive: &#39;
                &#39;two-level bullet list expected, but row %s does not &#39;
                &#39;contain a second-level bullet list.&#39;
                % (self.directive.name, rowNum + 1))

        for cellItem in cell:
            cspan, rspan, cellElements = self.parseCellItem(cellItem)
            if target is not None:
                cellElements.insert(0, target)
            row.append( (cspan, rspan, cellElements) )
        return row</div>

<div class="viewcode-block" id="ListTableBuilder.parseCellItem"><a class="viewcode-back" href="../../linuxdoc-api/linuxdoc.rstFlatTable.html#linuxdoc.rstFlatTable.ListTableBuilder.parseCellItem">[docs]</a>    def parseCellItem(self, cellItem):  # pylint: disable=no-self-use
        # search and remove cspan, rspan colspec from the first element in
        # this listItem (field).
        cspan = rspan = 0
        if not len(cellItem): # pylint: disable=len-as-condition
            return cspan, rspan, []
        for elem in cellItem[0]:
            if isinstance(elem, colSpan):
                cspan = elem.get(&quot;span&quot;)
                elem.parent.remove(elem)
                continue
            if isinstance(elem, rowSpan):
                rspan = elem.get(&quot;span&quot;)
                elem.parent.remove(elem)
                continue
        return cspan, rspan, cellItem[:]</div></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
  <span id="sidebar-top"></span>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  
    
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/darmarIT_logo_128.png" alt="Logo"/>
            </a></p>
  

  <h3>Project Links</h3>
  <ul>
    <li><a href="https://return42.github.io/linuxdoc">Home</a>
  
    <li><a href="https://github.com/return42/linuxdoc">Source</a>
  
    <li><a href="https://return42.github.io/linuxdoc/linuxdoc-api/linuxdoc.html">API</a>
  
    <li><a href="https://github.com/return42/linuxdoc">Source</a>
  
    <li><a href="https://github.com/return42/linuxdoc/issues">Issue Tracker</a>
  
    <li><a href="mailto:markus.heiser@darmarIT.de">Contact</a>
  </ul><h3>Navigation</h3>
<ul>
  <li><a href="../../index.html">Overview</a>
    <ul>
      <li><a href="../index.html">Module code</a>
        
          
          </ul>
      </li>
    </ul>
  </li>
</ul>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  
    <div class="footer" role="contentinfo">
        &#169; Copyright 2021 Markus Heiser.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.3.0.
    </div>
  <script src="../../_static/version_warning_offset.js"></script>

  </body>
</html>